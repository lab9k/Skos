% Docker
Skosmos werd opgezet a.d.h.v. Docker. De Dockerfile kan men \href{https://github.com/lab9k/Skos/blob/master/Dockerfile}{hier} vinden. In de volgende paragrafen zullen we een korte samenvatting geven over hoe Docker werkt en kan gebruikt worden.

\subsection{Opzetten in Docker}
Allereerst moet Docker natuurlijk ge√Ønstalleerd worden, we raden tenhartste aan dit op een linux distributie te doen.\footnote{Gebruik deze handige  \href{https://docs.docker.com/install/linux/docker-ce/ubuntu/}{install guide} voor ubuntu.}

Met Docker kan men een \textit{image} die de nodige software en configuratie bevatten voor applicatie. Zo worden alle applicaties en hun dependencies mooi verzameld en afgesloten van de buitenwereld. Een \textbf{image} kan men beschouwen als een \textit{class definition}. De afgeleide instanties van deze klassen noemen we \textbf{containers}.

Je kan uiteraard meerder intstanties van dezelfde image maken, alle containers die op de machine runnen kan je oplijsten met \mintinline{bash}{docker ps}. Gebruik de \textit{--all} flag om ook de containers die niet runnen te zien. Om een instantie van een image te maken gebruik je het commando \textit{docker run}.

\begin{minted}{bash}
$ docker run -d --name=<container_name> <image_name>
\end{minted}

De \textit{-d} flag zorgt ervoor dat de container na aanmaak in de achtergrond te runnen. De output van het commando is de container. Men kan nu toegang verkrijgen tot de nieuwe container door het \textit{bash} commando uit te voeren en aan onze terminal te hangen.

\begin{minted}{bash}
$ docker exec -it apache_server bash
\end{minted}

% TODO Dockerfile

Voor een uitgebreidere uitleg is deze \href{https://semaphoreci.com/community/tutorials/dockerizing-a-php-application}{tutorial} alvast een goede inleiding tot Docker. We werkten echter niet met VM's en docker-machine zoals in het eerste deel van de tutorial wordt besproken, je kan dit dus negeren. 

\subsection{Dockerfile}
We kunnen nu goed overweg met docker containers, hoe komen we echter aan een image? Dit doen we met een \textbf{Dockerfile}. Op \href{https://hub.docker.com/}{Docker HUB} vind je al Dockerfiles van de community. We willen natuurlijk op al bestaande images uitbreiden dit kan makkelijk met FROM. 

\begin{minted}{bash}
# Dockerfile
FROM nimmis/apache-php5

COPY 000-default.conf /etc/apache2/sites-available/000-default.conf

EXPOSE 80
EXPOSE 443
\end{minted}

Het FROM commando geeft ons dan een apache web server met php5. Daarop kunnen we dan allerlei extra configuratie aan toevoegen met commando's zoals COPY, RUN, EXPOSE, enzovoort.

Om even onze klasse analogie verder te zetten kunnen we hier \textit{nimmis/apache-php5} als generieke basisklasse zien, waarvan de klasse die onze Dockerfile maakt overerft. Docker ondersteund enkel enkelvoudige overerving. We kunnen dus maar 1 FROM hebben per image die we maken.\footnote{Zie deze  \href{https://github.com/moby/moby/issues/3378}{github issue} voor verdere uitleg.}

\subsection{Workflow}
Als men met Docker werkt zal met bij het opzetten van een container meestal de volgende stappen steeds uitvoeren:

% TODO add as appendix + remove old image and container
\begin{minted}{bash}
#!/bin/bash

image_name="kies een naam"
container_name="kies een naam"

# build image
sudo docker build -t $image_name .

# build container
sudo docker run -itd --name=$container_name $image_name

# attach to container with bash
sudo docker exec -it $container_name bash

\end{minted}

\subsection{Container networking}
Als je Docker installeerd maakt het automatisch de volgende 3 netwerken aan.

\begin{minted}{bash}
$ docker network ls

NETWORK ID          NAME                DRIVER
7fca4eb8c647        bridge              bridge
9f904ee27bf5        none                null
cf03ee007fb4        host                host
\end{minted}

Het \textit{bridge} netwerk stelt het \textit{docker0} netwerk dat deel uitmaakt van de host's netwerk stack. Dit kan je ook nagaan met het commando \mintinline{bash}{ip addr show}.

De Docker daemon connecteert containers standaard met dit netwerk. Wilt men echter een container aan een andere netwerk - bv. het host netwerk - toevoegen kan dit met de \textit{--network} flag bij het run commando.

\begin{minted}{bash}
sudo docker run -itd --network=host --name=<container_name> <image_name>
\end{minted}

Het \textit{host} network voegt een container op de host's netwerk stack, dus op het netwerk niveau is er geen isolatie tussen de container en de host. Met andere woorden als de container een web server draait op poort 80 dan is deze ook beschikbaar op poort 80 van de host machine.